name: Node.js build

on:
    push:
        branches: ["**"]
    pull_request:
        branches: ["**"]

jobs:
    build:
        runs-on: ubuntu-latest

        strategy:
            matrix:
                node-version: [20.x, 22.x]
                # See supported Node.js release schedule at https://nodejs.org/en/about/releases/

        steps:
            - uses: actions/checkout@v4
            - name: Use Node.js ${{ matrix.node-version }}
				uses: actions/setup-node@v4
				with:
					node-version: ${{ matrix.node-version }}
					cache: "npm"
				- run: npm ci
				- run: npm run build --if-present
				- run: npm run lint
		
			- name: Checkout code
				uses: actions/checkout@v4

			- name: Setup Node.js
				uses: actions/setup-node@v4
				with:
				node-version: '20'
				cache: 'npm'

			- name: Install Dependencies
				run: npm ci

			# 1. Verify TypeScript compiles (Checks for Error [2345] and others)
			- name: Type Check
				run: npx tsc --noEmit

			# 2. Run ESLint (Checks for Floating Promises / Async-Await safety)
			- name: Lint (ESLint)
				run: npm run lint

			# 3. Check Code Formatting (Requires a .prettierrc file)
			- name: Format Check (Prettier)
				run: npx prettier --check .

			# 4. Check for Dead Code (Knip)
			- name: Dead Code Analysis (Knip)
				run: npx knip

			# 5. Check for Circular Dependencies (Madge)
			- name: Circular Dependency Check
				run: npx madge --circular src/main.ts

			# 6. Verify Build Output
			- name: Build Plugin
				run: npm run build
