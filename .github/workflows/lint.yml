name: Plugin Quality & Build

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  build-and-validate:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 22.x
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Type Check (tsc)
        run: npx tsc --noEmit

      - name: Lint (ESLint - Async/Await checks)
        run: npm run lint

      # - name: Formatting Check (Prettier)
      #   run: npx prettier --check .
      #   continue-on-error: true
      #
      # - name: Dead Code Analysis (Knip)
      #   run: npx knip
      #   continue-on-error: true

      - name: Circular Dependency Check (Madge)
        run: npx madge --circular src/main.ts

      - name: Validate Obsidian Manifest
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const errors = [];

            if (!fs.existsSync('manifest.json')) {
              core.setFailed("Missing manifest.json");
              return;
            }

            const manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'));

            if (manifest.id.includes('obsidian')) errors.push("ID contains 'obsidian'");
            if (manifest.id.endsWith('plugin')) errors.push("ID ends with 'plugin'");
            if (manifest.name.toLowerCase().includes('obsidian')) errors.push("Name contains 'Obsidian'");
            if (manifest.description.length > 250) errors.push("Description > 250 chars");

            if (errors.length > 0) {
              const body = "### Obsidian Manifest Issues\n" + errors.map(e => `‚ùå ${e}`).join('\n');
              if (context.issue.number) {
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: body
                });
              }
              core.setFailed("Manifest validation failed");
            }

      - name: Build Plugin
        run: npm run build --if-present

      - name: Check Build Output
        run: |
          if [ ! -f main.js ]; then
            echo "Build failed to produce main.js"
            exit 1
          fi

      - name: Check Build Output
        run: |
          if [ ! -f main.js ]; then
            echo "Build failed to produce main.js"
            exit 1
          fi
