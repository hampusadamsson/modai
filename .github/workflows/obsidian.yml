name: Plugin CI

on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate Manifest and Structure
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const errors = [];
            const addError = (err) => {
              errors.push(`❌ ${err}`);
              console.error('Error: ' + err);
            };

            // 1. Check for required files
            const requiredFiles = ['manifest.json', 'main.js', 'styles.css'];
            // Note: styles.css is optional for some, but recommended. 
            // Remove from list if you don't use CSS.
            requiredFiles.forEach(file => {
              if (!fs.existsSync(file)) {
                if(file !== 'styles.css') addError(`Missing required file: ${file}`);
              }
            });

            // 2. Validate manifest.json
            let manifest;
            try {
              manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'));
            } catch (e) {
              addError('Could not parse manifest.json. Ensure it is valid JSON.');
              return;
            }

            // 3. Check ID and Name rules
            const { id, name, description, version } = manifest;

            if (id.toLowerCase().includes('obsidian')) addError('ID should not contain "obsidian".');
            if (id.endsWith('plugin')) addError('ID should not end with "plugin".');
            if (!/^[a-z0-9-_]+$/.test(id)) addError('ID must be lowercase alphanumeric with dashes/underscores.');

            if (name.toLowerCase().includes('obsidian')) addError('Name should not contain "Obsidian".');
            
            if (description.length > 250) addError('Description is too long (>250 chars).');
            if (!/[.?!) ]$/.test(description)) addError('Description should end with proper punctuation.');

            // 4. Version Check
            if (!/^[0-9.]+$/.test(version)) {
              addError('Version number in manifest must only contain numbers and dots.');
            }

            // 5. Finalize
            if (errors.length > 0) {
              core.setFailed("Plugin validation failed. See log for details.");
              
              // Optional: Comment on PR if this is a PR
              if (context.issue.number) {
                const body = "### Build Validation Failed\n" + errors.join('\n');
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: body
                });
              }
            } else {
              console.log("✅ All checks passed!");
            }
